/*
 * $Id$
 */
#include "bbslib.h"
/*
int main() {
	FILE *fp;
	struct fileheader f;
	char path[80], file[80], *id;
	int num=0;
	initwww_all();
	if(loginok == 0) http_fatal("您尚未登录");
	id=getCurrentUser()->userid;
	strsncpy(file, getparm("file"), 20);
	if(strncmp(file, "M.", 2) || strstr(file, "..")) http_fatal("错误的参数");
	sprintf(path, "mail/%c/%s/.DIR", toupper(id[0]), id);
	fp=fopen(path, "r");
	if(fp==0) http_fatal("错误的参数2");
	while(1) {
		if(fread(&f, sizeof(f), 1, fp)<=0) break;
		num++;
		if(!strcmp(f.filename, file)) {
			fclose(fp);
			delete_record(path, sizeof(struct fileheader), num-1);
			printf("信件已删除.<br><a href=bbsmail>返回所有信件列表</a>\n");
			http_quit();
		}
	}
	fclose(fp);
	http_fatal("信件不存在, 无法删除");
}*/
int main()
{
    FILE *fp;
    struct fileheader f;
    char path[80], file[80], *id,dirname[15],title[20];
    int num = 0;

    initwww_all();
    if (loginok == 0)
        http_fatal("您尚未登录");
    id = getCurrentUser()->userid;
    strsncpy(file, getparm("file"), 20);
    strsncpy(dirname, getparm("dir"), 15);
    strsncpy(title,getparm("title"),20);

    if (strncmp(file, "M.", 2) || strstr(file, ".."))
        http_fatal("错误的参数");
    sprintf(path, "mail/%c/%s/%s", toupper(id[0]), id,dirname);
    fp = fopen(path, "r");
    if (fp == 0)
        http_fatal("错误的参数2");
    while (1) {
        if (fread(&f, sizeof(f), 1, fp) <= 0)
            break;
        num++;
        if (!strcmp(f.filename, file)) {
            fclose(fp);
            sprintf(path, "mail/%c/%s/%s", toupper(id[0]), id, dirname);
            del_mail(num, &f, path);
	    printf("信件已删除.<br><a href=\"/bbsreadmail.php?path=%s&title=%s\">返回信件列表</a>\n",dirname,title);
            http_quit();
        }
    }
    fclose(fp);
    http_fatal("信件不存在, 无法删除");
}
